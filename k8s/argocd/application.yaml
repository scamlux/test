apiVersion: v1
kind: Namespace
metadata:
  name: argocd
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: agri-platform
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/yourusername/agri-platform-gitops.git
    targetRevision: main
    path: .
  destination:
    server: https://kubernetes.default.svc
    namespace: agri-platform
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  notifications:
    enabled: true
---
apiVersion: v1
kind: Namespace
metadata:
  name: agri-platform
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notification-cm
  namespace: argocd
data:
  service.grafana: |
    token: $grafana-token
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.finishedAt != '' and app.status.operationState.phase in ['Succeeded']
      oncePer: app.status.operationState.finishedAt
      send: [app-sync-succeeded]
  trigger.on-sync-failed: |
    - when: app.status.operationState.finishedAt != '' and app.status.operationState.phase in ['Error', 'Failed']
      oncePer: app.status.operationState.finishedAt
      send: [app-sync-failed]
  template.app-sync-succeeded: |
    grafana:
      title: 'ArgoCD Deployment Succeeded'
      state: 'ok'
      message: 'Application {{.app.metadata.name}} deployment succeeded'
      dashboardUID: 'agri-platform'
  template.app-sync-failed: |
    grafana:
      title: 'ArgoCD Deployment Failed'
      state: 'alerting'
      message: 'Application {{.app.metadata.name}} deployment failed'
      dashboardUID: 'agri-platform'
---
apiVersion: v1
kind: Secret
metadata:
  name: github-repo-creds
  namespace: argocd
type: Opaque
stringData:
  type: git
  url: https://github.com/yourusername/agri-platform-gitops.git
  password: ${{ secrets.GITHUB_TOKEN }}
  username: yourusername
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-controller
  namespace: agri-platform
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-agri-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
subjects:
  - kind: ServiceAccount
    name: argocd-controller
    namespace: agri-platform

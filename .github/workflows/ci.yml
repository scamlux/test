name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ===== CI =====
      - name: Install dependencies
        run: |
          cd services/order-service && npm install
          cd ../inventory-service && npm install
          cd ../payment-service && npm install
          cd ../query-service && npm install

      # ===== BUILD =====
      - name: Build Docker images
        run: |
          docker build -t order-service:${{ github.sha }} services/order-service
          docker build -t inventory-service:${{ github.sha }} services/inventory-service
          docker build -t payment-service:${{ github.sha }} services/payment-service
          docker build -t query-service:${{ github.sha }} services/query-service

      # ===== AUTODEPLOY =====
      - name: Auto deploy (if build passed)
        env:
          TAG: ${{ github.sha }}
        run: |
          echo "Deploying version $TAG"
          docker compose -f docker-compose.deploy.yml up -d
